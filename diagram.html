<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gemini Robotics ER — System Architecture</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, 'Helvetica Neue', 'Inter', sans-serif; background: #0a0e1a; color: #e2e8f0; overflow-x: hidden; }
  .page { max-width: 1200px; margin: 0 auto; padding: 32px 24px 60px; }
  h1 { text-align: center; font-size: 36px; color: #f8fafc; margin-bottom: 4px; letter-spacing: -0.5px; }
  .subtitle { text-align: center; color: #64748b; font-size: 14px; margin-bottom: 48px; }
  .section-title {
    font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;
    color: #6366f1; margin-bottom: 20px; margin-top: 56px; display: flex; align-items: center; gap: 10px;
  }
  .section-title::after { content: ''; flex: 1; height: 1px; background: linear-gradient(90deg, #6366f1 0%, transparent 100%); }
  .section-title:first-of-type { margin-top: 0; }
  code, .mono { font-family: 'SF Mono', 'Fira Code', 'JetBrains Mono', monospace; }

  /* === 1. Architecture Overview === */
  .arch-pillars { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
  .pillar {
    background: linear-gradient(145deg, #1e293b, #0f172a); border-radius: 16px;
    padding: 24px 18px; border: 1px solid #334155; text-align: center; position: relative;
  }
  .pillar .icon { font-size: 32px; margin-bottom: 10px; }
  .pillar .title { font-size: 15px; font-weight: 700; color: #f1f5f9; margin-bottom: 4px; }
  .pillar .tech { font-size: 11px; color: #6366f1; font-weight: 600; margin-bottom: 8px; }
  .pillar .desc { font-size: 11px; color: #94a3b8; line-height: 1.5; }
  .pillar.ui { border-top: 3px solid #6366f1; }
  .pillar.ai { border-top: 3px solid #a78bfa; }
  .pillar.render { border-top: 3px solid #22d3ee; }
  .pillar.physics { border-top: 3px solid #34d399; }
  .arch-connectors {
    display: flex; justify-content: center; gap: 80px; margin-bottom: 20px;
    font-size: 12px; color: #475569;
  }
  .arch-connectors span { display: flex; align-items: center; gap: 6px; }
  .arch-connectors .arrow { color: #6366f1; font-size: 16px; }

  /* === 2. Sense-Plan-Act Pipeline === */
  .pipeline { margin-bottom: 20px; }
  .pipe-steps { display: flex; gap: 0; align-items: stretch; overflow-x: auto; padding: 4px 0; }
  .pipe-step {
    flex: 1; min-width: 160px; padding: 16px 14px; position: relative;
    border: 1px solid #334155; background: #0f172a;
  }
  .pipe-step:first-child { border-radius: 14px 0 0 14px; }
  .pipe-step:last-child { border-radius: 0 14px 14px 0; }
  .pipe-step .num {
    width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center;
    justify-content: center; font-size: 11px; font-weight: 700; color: white; margin-bottom: 8px;
  }
  .pipe-step .name { font-size: 13px; font-weight: 700; color: #f1f5f9; margin-bottom: 4px; }
  .pipe-step .file { font-size: 10px; color: #6366f1; font-family: 'SF Mono', monospace; margin-bottom: 6px; }
  .pipe-step .detail { font-size: 11px; color: #94a3b8; line-height: 1.5; }
  .pipe-step .data-shape {
    margin-top: 8px; background: #1e293b; border-radius: 6px; padding: 6px 8px;
    font-family: 'SF Mono', monospace; font-size: 9px; color: #22d3ee; line-height: 1.4;
    border: 1px solid #334155;
  }
  .pipe-step::after {
    content: ''; position: absolute; right: -8px; top: 50%; transform: translateY(-50%);
    width: 0; height: 0; border: 7px solid transparent; border-left-color: #6366f1; z-index: 1;
  }
  .pipe-step:last-child::after { display: none; }
  .pipe-step:nth-child(1) .num { background: #6366f1; }
  .pipe-step:nth-child(2) .num { background: #0891b2; }
  .pipe-step:nth-child(3) .num { background: #a78bfa; }
  .pipe-step:nth-child(4) .num { background: #f59e0b; }
  .pipe-step:nth-child(5) .num { background: #22c55e; }
  .pipe-step:nth-child(6) .num { background: #ef4444; }

  /* === 3. Main Loop === */
  .loop-diagram {
    display: grid; grid-template-columns: 1fr 1fr; gap: 16px;
  }
  .loop-box {
    background: #0f172a; border: 1px solid #334155; border-radius: 14px; padding: 20px;
  }
  .loop-box h4 { font-size: 14px; color: #f1f5f9; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
  .loop-box h4 .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .loop-code {
    background: #1e293b; border-radius: 8px; padding: 14px; font-family: 'SF Mono', monospace;
    font-size: 11px; line-height: 1.7; color: #94a3b8; border: 1px solid #334155; overflow-x: auto;
  }
  .loop-code .kw { color: #c084fc; }
  .loop-code .fn { color: #22d3ee; }
  .loop-code .cm { color: #475569; }
  .loop-code .str { color: #34d399; }
  .loop-code .num { color: #f59e0b; }

  /* === 4. Full State Machine === */
  .sm-full { overflow-x: auto; padding-bottom: 10px; }
  .sm-track {
    display: flex; gap: 4px; align-items: stretch; min-width: max-content; padding: 4px;
  }
  .sm-step {
    min-width: 95px; border-radius: 10px; padding: 10px 8px; text-align: center;
    border: 2px solid; flex-shrink: 0; position: relative;
  }
  .sm-step .snum { font-size: 9px; font-weight: 800; opacity: 0.5; margin-bottom: 2px; }
  .sm-step .sname { font-size: 11px; font-weight: 700; margin-bottom: 2px; }
  .sm-step .sdesc { font-size: 9px; opacity: 0.7; line-height: 1.3; }
  .sm-step .stime { font-size: 9px; margin-top: 4px; opacity: 0.5; font-family: 'SF Mono', monospace; }
  .sm-arr { display: flex; align-items: center; color: #475569; font-size: 14px; flex-shrink: 0; }
  /* Phase colors */
  .sm-step.approach { background: #1e1b4b; border-color: #6366f1; color: #c7d2fe; }
  .sm-step.open-g { background: #164e63; border-color: #06b6d4; color: #a5f3fc; }
  .sm-step.descend { background: #451a03; border-color: #f59e0b; color: #fde68a; }
  .sm-step.wait { background: #1a1a2e; border-color: #475569; color: #94a3b8; }
  .sm-step.grasp-g { background: #14532d; border-color: #22c55e; color: #bbf7d0; }
  .sm-step.lift-g { background: #3b0764; border-color: #a855f7; color: #e9d5ff; }
  .sm-step.transport { background: #1e3a5f; border-color: #3b82f6; color: #bfdbfe; }
  .sm-step.release { background: #450a0a; border-color: #ef4444; color: #fecaca; }
  .sm-step.home { background: #064e3b; border-color: #10b981; color: #a7f3d0; }
  .sm-loop-label {
    text-align: center; margin-top: 10px; font-size: 11px; color: #6366f1;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .sm-loop-label::before, .sm-loop-label::after { content: ''; width: 60px; height: 1px; background: #6366f1; }

  /* === 5. IK Deep Dive === */
  .ik-deep { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
  .ik-panel {
    background: linear-gradient(145deg, #1e293b, #0f172a); border-radius: 14px;
    padding: 20px; border: 1px solid #334155;
  }
  .ik-panel h4 { font-size: 14px; color: #f1f5f9; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
  .ik-panel h4 .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .ik-panel p { font-size: 12px; color: #94a3b8; line-height: 1.6; margin-bottom: 8px; }
  .ik-formula {
    background: #0f172a; border: 1px solid #1e293b; border-radius: 8px;
    padding: 10px 14px; font-family: 'SF Mono', monospace; font-size: 12px; color: #a78bfa;
    text-align: center; margin: 8px 0;
  }
  .ik-steps { list-style: none; counter-reset: ik; }
  .ik-steps li {
    counter-increment: ik; padding: 8px 0 8px 30px; position: relative;
    font-size: 12px; color: #94a3b8; line-height: 1.5; border-bottom: 1px solid #1e293b;
  }
  .ik-steps li:last-child { border: none; }
  .ik-steps li::before {
    content: counter(ik); position: absolute; left: 0; top: 8px;
    width: 22px; height: 22px; border-radius: 50%; background: #312e81;
    color: #a78bfa; font-size: 11px; font-weight: 700; display: flex; align-items: center;
    justify-content: center;
  }
  .ik-steps li strong { color: #e2e8f0; }
  .joint-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  .joint-table th, .joint-table td {
    padding: 6px 8px; font-size: 11px; text-align: left; border-bottom: 1px solid #1e293b;
  }
  .joint-table th { color: #6366f1; font-weight: 600; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }
  .joint-table td { color: #94a3b8; }
  .joint-table td:first-child { color: #e2e8f0; font-weight: 600; }
  .joint-table td:last-child { font-family: 'SF Mono', monospace; color: #22d3ee; font-size: 10px; }

  /* === 6. 2D→3D Projection === */
  .proj-section { display: grid; grid-template-columns: 2fr 1fr; gap: 16px; }
  .proj-viz {
    background: #0f172a; border: 1px solid #334155; border-radius: 14px; padding: 24px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .proj-svg { width: 100%; max-width: 500px; }
  .proj-info {
    background: #0f172a; border: 1px solid #334155; border-radius: 14px; padding: 20px;
  }
  .proj-info h4 { font-size: 14px; color: #f1f5f9; margin-bottom: 12px; }
  .proj-info .step-list { list-style: none; }
  .proj-info .step-list li {
    padding: 6px 0; font-size: 12px; color: #94a3b8; line-height: 1.5;
    border-bottom: 1px solid #1e293b; display: flex; gap: 8px;
  }
  .proj-info .step-list li:last-child { border: none; }
  .proj-info .step-list .sn {
    width: 20px; height: 20px; border-radius: 50%; background: #312e81; color: #a78bfa;
    font-size: 10px; font-weight: 700; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; margin-top: 1px;
  }

  /* === 7. Detection Modes === */
  .modes-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
  .mode-card {
    background: #1e293b; border-radius: 14px; padding: 18px; border: 1px solid #334155; text-align: center;
  }
  .mode-card .icon { font-size: 28px; margin-bottom: 6px; }
  .mode-card .name { font-size: 15px; font-weight: 700; color: #f1f5f9; margin-bottom: 4px; }
  .mode-card .en { font-size: 11px; color: #6366f1; margin-bottom: 8px; }
  .mode-card .desc { font-size: 11px; color: #94a3b8; line-height: 1.5; text-align: left; }
  .mode-card .output {
    margin-top: 8px; background: #0f172a; border-radius: 8px; padding: 8px;
    font-family: 'SF Mono', monospace; font-size: 10px; color: #64748b; text-align: left;
  }
  .mode-card.boxes { border-top: 3px solid #22d3ee; }
  .mode-card.masks { border-top: 3px solid #a78bfa; }
  .mode-card.points { border-top: 3px solid #34d399; }

  /* === 8. File Map === */
  .dep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
  .dep-card {
    background: #1e293b; border-radius: 12px; padding: 14px; border: 1px solid #334155;
    transition: border-color 0.2s;
  }
  .dep-card:hover { border-color: #6366f1; }
  .dep-card .fname { font-size: 12px; font-weight: 700; color: #e2e8f0; font-family: 'SF Mono', monospace; margin-bottom: 3px; }
  .dep-card .lines { font-size: 9px; color: #475569; margin-bottom: 5px; }
  .dep-card .role { font-size: 10px; color: #94a3b8; line-height: 1.4; }
  .dep-card .deps { margin-top: 6px; display: flex; flex-wrap: wrap; gap: 3px; }
  .dep-tag {
    font-size: 8px; padding: 2px 5px; border-radius: 4px; font-weight: 600;
    background: #0f172a; color: #64748b; border: 1px solid #1e293b;
  }
  .dep-tag.i { color: #22d3ee; border-color: #164e63; }
  .dep-tag.e { color: #a78bfa; border-color: #3b0764; }
  .dep-card.ui { border-left: 3px solid #6366f1; }
  .dep-card.ren { border-left: 3px solid #22d3ee; }
  .dep-card.phy { border-left: 3px solid #34d399; }
  .dep-card.ctrl { border-left: 3px solid #f59e0b; }

  /* === Footer === */
  .tech-footer {
    display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;
    padding: 24px 0; margin-top: 40px; border-top: 1px solid #1e293b;
  }
  .tech-pill {
    padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: 600;
    border: 1px solid #334155; color: #94a3b8; background: #1e293b;
    display: flex; align-items: center; gap: 5px;
  }
  .tech-pill .ver { color: #6366f1; }

  /* Responsive */
  @media (max-width: 900px) {
    .arch-pillars { grid-template-columns: repeat(2, 1fr); }
    .pipe-steps { flex-direction: column; }
    .pipe-step { border-radius: 10px !important; }
    .pipe-step::after { display: none; }
    .loop-diagram, .ik-deep, .proj-section { grid-template-columns: 1fr; }
    .modes-grid { grid-template-columns: 1fr; }
    .dep-grid { grid-template-columns: repeat(2, 1fr); }
  }
</style>
</head>
<body>
<div class="page">

<h1>Franka Panda Pick &amp; Place</h1>
<p class="subtitle">Full System Architecture | Gemini Embodied Reasoning + MuJoCo WASM + Three.js</p>

<!-- ============================================================ -->
<!-- 1. FOUR PILLARS -->
<!-- ============================================================ -->
<div class="section-title">1. Four-Pillar Architecture</div>
<div class="arch-pillars">
  <div class="pillar ui">
    <div class="icon">&#x1F4BB;</div>
    <div class="title">User Interface</div>
    <div class="tech">React 19 + TypeScript</div>
    <div class="desc">Sidebar controls, API key input, detection mode selector, interaction history log</div>
  </div>
  <div class="pillar ai">
    <div class="icon">&#x1F9E0;</div>
    <div class="title">AI Vision</div>
    <div class="tech">Gemini Robotics ER 1.5</div>
    <div class="desc">Analyzes 2D screenshots, returns object coordinates (boxes / masks / points)</div>
  </div>
  <div class="pillar render">
    <div class="icon">&#x1F3A8;</div>
    <div class="title">3D Rendering</div>
    <div class="tech">Three.js r181</div>
    <div class="desc">Scene graph, camera control, shadows, 2D&rarr;3D raycasting projection</div>
  </div>
  <div class="pillar physics">
    <div class="icon">&#x2699;&#xFE0F;</div>
    <div class="title">Physics Engine</div>
    <div class="tech">MuJoCo WASM</div>
    <div class="desc">Rigid body dynamics, contact forces, friction, gravity &mdash; all in-browser</div>
  </div>
</div>

<!-- ============================================================ -->
<!-- 2. SENSE-PLAN-ACT PIPELINE -->
<!-- ============================================================ -->
<div class="section-title">2. Sense-Plan-Act Pipeline</div>
<div class="pipeline">
<div class="pipe-steps">
  <div class="pipe-step">
    <div class="num">1</div>
    <div class="name">User Prompt</div>
    <div class="file">UnifiedSidebar.tsx</div>
    <div class="detail">User enters target description and selects detection mode</div>
    <div class="data-shape">prompt: "red cubes"<br>type: "2D bounding boxes"</div>
  </div>
  <div class="pipe-step">
    <div class="num">2</div>
    <div class="name">Camera Snapshot</div>
    <div class="file">RenderSystem.ts</div>
    <div class="detail">Camera flies to top-down view, captures canvas as base64 PNG (max 640px)</div>
    <div class="data-shape">camera &rarr; (0, -0.01, 2.0)<br>output: "data:image/png;base64,..."</div>
  </div>
  <div class="pipe-step">
    <div class="num">3</div>
    <div class="name">Gemini Inference</div>
    <div class="file">App.tsx:300-312</div>
    <div class="detail">Image + prompt sent to Gemini API. Returns JSON array of detected objects</div>
    <div class="data-shape">[{box_2d: [y1,x1,y2,x2],<br>&nbsp;label: "red cube"}, ...]</div>
  </div>
  <div class="pipe-step">
    <div class="num">4</div>
    <div class="name">2D &rarr; 3D Projection</div>
    <div class="file">RenderSystem.ts:254</div>
    <div class="detail">Normalized 2D center &rarr; NDC &rarr; Three.js Raycaster &rarr; mesh intersection = 3D point</div>
    <div class="data-shape">(500, 300) &rarr; NDC(0.0, 0.4)<br>&rarr; Vector3(0.4, -0.1, 0.04)</div>
  </div>
  <div class="pipe-step">
    <div class="num">5</div>
    <div class="name">IK Solve</div>
    <div class="file">FrankaAnalyticalIK.ts</div>
    <div class="detail">Target 3D pose &rarr; analytical geometry &rarr; 7 joint angles</div>
    <div class="data-shape">pose: {pos, quat}<br>&rarr; [1.7, -1.8, 0.0, -2.7,<br>&nbsp;&nbsp;&nbsp;0.0, 0.9, 2.5]</div>
  </div>
  <div class="pipe-step">
    <div class="num">6</div>
    <div class="name">Execute Pickup</div>
    <div class="file">SequenceAnimator.ts</div>
    <div class="detail">15-step state machine drives joints with smoothstep interpolation</div>
    <div class="data-shape">ctrl[0..6] = lerp(start, end)<br>ctrl[7] = gripperVal</div>
  </div>
</div>
</div>

<!-- ============================================================ -->
<!-- 3. MAIN LOOP ARCHITECTURE -->
<!-- ============================================================ -->
<div class="section-title">3. Main Loop (60 FPS)</div>
<div class="loop-diagram">
  <div class="loop-box">
    <h4><span class="dot" style="background:#34d399"></span> Physics Loop &mdash; MujocoSim.ts:184-230</h4>
    <div class="loop-code">
<span class="kw">loop</span>() {<br>
&nbsp;&nbsp;<span class="cm">// 1. Handle mouse drag forces</span><br>
&nbsp;&nbsp;<span class="fn">dragStateManager</span>.<span class="fn">update</span>();<br>
&nbsp;&nbsp;<span class="fn">applyDragForce</span>();<br>
<br>
&nbsp;&nbsp;<span class="cm">// 2. Animate IK gizmo if moving</span><br>
&nbsp;&nbsp;<span class="kw">if</span> (<span class="fn">gizmoAnim</span>.active)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">lerpVectors</span>() + <span class="fn">slerpQuaternions</span>();<br>
<br>
&nbsp;&nbsp;<span class="cm">// 3. Update control system</span><br>
&nbsp;&nbsp;<span class="kw">if</span> (sequenceAnimator.running)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">sequenceAnimator</span>.<span class="fn">update</span>(dt);<br>
&nbsp;&nbsp;<span class="kw">else</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">ikSys</span>.<span class="fn">update</span>(model, data);<br>
<br>
&nbsp;&nbsp;<span class="cm">// 4. Step physics (supports speed multiplier)</span><br>
&nbsp;&nbsp;<span class="kw">while</span> (time &lt; <span class="num">1/60</span> * speedMultiplier)<br>
&nbsp;&nbsp;&nbsp;&nbsp;mujoco.<span class="fn">mj_step</span>(model, data);<br>
<br>
&nbsp;&nbsp;<span class="cm">// 5. Sync to renderer</span><br>
&nbsp;&nbsp;<span class="fn">renderSys</span>.<span class="fn">update</span>(data);<br>
}
    </div>
  </div>
  <div class="loop-box">
    <h4><span class="dot" style="background:#22d3ee"></span> Render Update &mdash; RenderSystem.ts:148-182</h4>
    <div class="loop-code">
<span class="fn">update</span>(mjData) {<br>
&nbsp;&nbsp;<span class="cm">// 1. Camera animation (if flying)</span><br>
&nbsp;&nbsp;<span class="kw">if</span> (isAnimatingCamera)<br>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="fn">lerpVectors</span>(startPos, endPos, ease);<br>
<br>
&nbsp;&nbsp;<span class="cm">// 2. Sync every body to physics state</span><br>
&nbsp;&nbsp;<span class="kw">for</span> (body <span class="kw">in</span> bodies) {<br>
&nbsp;&nbsp;&nbsp;&nbsp;body.position = mjData.<span class="fn">xpos</span>[i*3];<br>
&nbsp;&nbsp;&nbsp;&nbsp;body.quaternion = mjData.<span class="fn">xquat</span>[i*4];<br>
&nbsp;&nbsp;}<br>
<br>
&nbsp;&nbsp;<span class="cm">// 3. Update contact point markers</span><br>
&nbsp;&nbsp;<span class="fn">updateContacts</span>(mjData);<br>
<br>
&nbsp;&nbsp;<span class="cm">// 4. Animate detection markers (float)</span><br>
&nbsp;&nbsp;markers.z = baseZ + <span class="fn">sin</span>(t * <span class="num">3</span>) * <span class="num">0.05</span>;<br>
<br>
&nbsp;&nbsp;<span class="cm">// 5. Draw frame</span><br>
&nbsp;&nbsp;renderer.<span class="fn">render</span>(scene, camera);<br>
}
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- 4. FULL 15-STEP STATE MACHINE -->
<!-- ============================================================ -->
<div class="section-title">4. Pick-and-Place State Machine (15 Steps)</div>
<div class="sm-full">
<div class="sm-track">
  <div class="sm-step approach">
    <div class="snum">0</div>
    <div class="sname">Move Over</div>
    <div class="sdesc">Horizontal move above cube</div>
    <div class="stime">2.0s &times; mul</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step approach">
    <div class="snum">1</div>
    <div class="sname">Hover</div>
    <div class="sdesc">Descend to +20cm above cube</div>
    <div class="stime">2.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step open-g">
    <div class="snum">2</div>
    <div class="sname">Open</div>
    <div class="sdesc">Open gripper val=255</div>
    <div class="stime">0.5s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step descend">
    <div class="snum">3</div>
    <div class="sname">Lower</div>
    <div class="sdesc">Descend onto cube surface</div>
    <div class="stime">4.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step wait">
    <div class="snum">4</div>
    <div class="sname">Wait</div>
    <div class="sdesc">Physics settle</div>
    <div class="stime">2.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step grasp-g">
    <div class="snum">5</div>
    <div class="sname">Grasp</div>
    <div class="sdesc">Close gripper val=0</div>
    <div class="stime">0.5s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step wait">
    <div class="snum">6</div>
    <div class="sname">Wait</div>
    <div class="sdesc">Grip stabilize</div>
    <div class="stime">1.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step lift-g">
    <div class="snum">7</div>
    <div class="sname">Lift</div>
    <div class="sdesc">Raise +20cm</div>
    <div class="stime">2.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step transport">
    <div class="snum">8</div>
    <div class="sname">Move</div>
    <div class="sdesc">To tray (cylindrical path)</div>
    <div class="stime">8.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step descend">
    <div class="snum">9</div>
    <div class="sname">Lower</div>
    <div class="sdesc">To drop height</div>
    <div class="stime">2.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step wait">
    <div class="snum">10</div>
    <div class="sname">Wait</div>
    <div class="sdesc">Stabilize</div>
    <div class="stime">0.5s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step release">
    <div class="snum">11</div>
    <div class="sname">Release</div>
    <div class="sdesc">Open gripper val=255</div>
    <div class="stime">0.5s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step wait">
    <div class="snum">12</div>
    <div class="sname">Wait</div>
    <div class="sdesc">Object falls</div>
    <div class="stime">1.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step lift-g">
    <div class="snum">13</div>
    <div class="sname">Lift</div>
    <div class="sdesc">Clear tray</div>
    <div class="stime">2.0s</div>
  </div>
  <div class="sm-arr">&rarr;</div>
  <div class="sm-step home">
    <div class="snum">14</div>
    <div class="sname">Next?</div>
    <div class="sdesc">Loop or Home</div>
    <div class="stime">2.0s</div>
  </div>
</div>
<div class="sm-loop-label">Step 14 loops back to Step 0 if more objects remain</div>
</div>

<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
  <div class="loop-box">
    <h4><span class="dot" style="background:#f59e0b"></span> Motion Interpolation</h4>
    <div class="loop-code">
<span class="cm">// Smoothstep easing (S-curve)</span><br>
p = timer / duration; <span class="cm">// 0.0 &rarr; 1.0</span><br>
ease = p * p * (<span class="num">3</span> - <span class="num">2</span> * p);<br>
<br>
<span class="cm">// Joint space interpolation</span><br>
<span class="kw">for</span> (i = <span class="num">0</span>; i &lt; <span class="num">7</span>; i++)<br>
&nbsp;&nbsp;ctrl[i] = start[i] + (end[i] - start[i]) * ease;<br>
<br>
<span class="cm">// Large moves: Cylindrical interpolation</span><br>
<span class="cm">// (prevents path through robot base)</span><br>
r = <span class="fn">lerp</span>(startR, endR, ease);<br>
&theta; = <span class="fn">lerp</span>(start&Theta;, end&Theta;, ease);<br>
pos = (<span class="fn">r&middot;cos&theta;</span>, <span class="fn">r&middot;sin&theta;</span>, <span class="fn">lerp</span>(z));<br>
    </div>
  </div>
  <div class="loop-box">
    <h4><span class="dot" style="background:#22c55e"></span> Stacking Logic (3&times;3 Grid)</h4>
    <div class="loop-code">
<span class="cm">// 9 cubes per layer, 3&times;3 grid</span><br>
layerIdx = <span class="fn">floor</span>(droppedCount / <span class="num">9</span>);<br>
posInLayer = droppedCount % <span class="num">9</span>;<br>
<br>
row = <span class="fn">floor</span>(posInLayer / <span class="num">3</span>); <span class="cm">// 0,1,2</span><br>
col = posInLayer % <span class="num">3</span>;             <span class="cm">// 0,1,2</span><br>
<br>
xOffset = (row - <span class="num">1</span>) * <span class="num">0.06</span>;<br>
yOffset = (col - <span class="num">1</span>) * <span class="num">0.06</span>;<br>
<br>
dropZ = <span class="num">0.005</span> + <span class="num">0.02</span> <span class="cm">// base + half cube</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ layerIdx * <span class="num">0.04</span> <span class="cm">// layer height</span><br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="num">0.06</span>;         <span class="cm">// clearance</span><br>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- 5. IK DEEP DIVE -->
<!-- ============================================================ -->
<div class="section-title">5. Inverse Kinematics Deep Dive</div>
<div class="ik-deep">
  <div class="ik-panel">
    <h4><span class="dot" style="background:#a78bfa"></span> Analytical Solver Algorithm</h4>
    <p>Based on He &amp; Liu: "Analytical Inverse Kinematics for Franka Emika Panda". A closed-form geometric method &mdash; no iteration needed.</p>
    <div class="ik-formula">T<sub>target</sub> = T<sub>0&rarr;1</sub>(q1) &times; T<sub>1&rarr;2</sub>(q2) &times; ... &times; T<sub>6&rarr;7</sub>(q7)</div>
    <ol class="ik-steps">
      <li><strong>Fix q7</strong> (redundancy parameter). Back-calculate wrist center p7 and joint origin p6 from the end-effector pose.</li>
      <li><strong>Solve q4</strong> (elbow angle). Triangle O2-O4-O6 + law of cosines. Check reachability.</li>
      <li><strong>Solve q6</strong> (2 candidates). Project O2O6 into Frame 6, solve sinusoidal equation.</li>
      <li><strong>Solve q1, q2</strong> (2 pairs). Shoulder flip cases from vector O2P direction.</li>
      <li><strong>Solve q3</strong>. Project x3 axis into Frame 2 using inverse rotation matrices.</li>
      <li><strong>Solve q5</strong>. Project HO4 vector through Frame 6 &rarr; Frame 5 transformation.</li>
      <li><strong>Filter</strong> all solutions against joint limits. Return valid configurations.</li>
    </ol>
  </div>
  <div class="ik-panel">
    <h4><span class="dot" style="background:#f59e0b"></span> Redundancy Resolution</h4>
    <p>7-DOF arm has infinite solutions per pose. The system resolves redundancy using a cost-minimization search over q7:</p>
    <div class="ik-formula">cost = 1.0 &times; ||q - q<sub>current</sub>||&sup2; + 0.05 &times; ||q - q<sub>neutral</sub>||&sup2;</div>
    <p><strong>Search strategy (3 tiers):</strong></p>
    <p>1. Try current q7 value (continuity)</p>
    <p>2. Scan q7 &plusmn; 0.5 rad (step 0.1 rad)</p>
    <p>3. Full range scan [-2.9, 2.9] (fallback)</p>
    <h4 style="margin-top:16px"><span class="dot" style="background:#22d3ee"></span> Joint Limits</h4>
    <table class="joint-table">
      <tr><th>Joint</th><th>Role</th><th>Range (rad)</th></tr>
      <tr><td>J1</td><td>Base rotation</td><td>[-2.90, 2.90]</td></tr>
      <tr><td>J2</td><td>Shoulder</td><td>[-1.76, 1.76]</td></tr>
      <tr><td>J3</td><td>Upper arm</td><td>[-2.90, 2.90]</td></tr>
      <tr><td>J4</td><td>Elbow</td><td>[-3.07, -0.07]</td></tr>
      <tr><td>J5</td><td>Forearm</td><td>[-2.90, 2.90]</td></tr>
      <tr><td>J6</td><td>Wrist</td><td>[-0.02, 3.75]</td></tr>
      <tr><td>J7</td><td>Flange</td><td>[-2.90, 2.90]</td></tr>
    </table>
  </div>
</div>

<!-- ============================================================ -->
<!-- 6. 2D→3D PROJECTION -->
<!-- ============================================================ -->
<div class="section-title">6. 2D &rarr; 3D Projection (Raycasting)</div>
<div class="proj-section">
  <div class="proj-viz">
    <svg class="proj-svg" viewBox="0 0 500 300" fill="none" xmlns="http://www.w3.org/2000/svg">
      <!-- Camera -->
      <rect x="200" y="10" width="100" height="50" rx="8" fill="#1e293b" stroke="#6366f1" stroke-width="2"/>
      <text x="250" y="40" text-anchor="middle" fill="#c7d2fe" font-size="12" font-weight="700">Camera</text>
      <text x="250" y="52" text-anchor="middle" fill="#6366f1" font-size="8">(0, -0.01, 2.0)</text>
      <!-- Ray -->
      <line x1="250" y1="60" x2="320" y2="220" stroke="#a78bfa" stroke-width="2" stroke-dasharray="6 3"/>
      <text x="300" y="140" fill="#a78bfa" font-size="10" transform="rotate(68 300 140)">Raycaster</text>
      <!-- 2D Image overlay -->
      <rect x="20" y="80" width="140" height="100" rx="8" fill="#0f172a" stroke="#334155" stroke-width="1"/>
      <text x="90" y="96" text-anchor="middle" fill="#64748b" font-size="9">2D Image (0-1000)</text>
      <rect x="80" y="120" width="40" height="30" rx="3" fill="none" stroke="#22d3ee" stroke-width="2"/>
      <circle cx="100" cy="135" r="3" fill="#22d3ee"/>
      <text x="100" y="168" text-anchor="middle" fill="#22d3ee" font-size="9">(500, 300)</text>
      <!-- Arrow from 2D to NDC -->
      <path d="M160 130 L195 130" stroke="#475569" stroke-width="1.5" marker-end="url(#arrowGray)"/>
      <!-- NDC box -->
      <rect x="195" y="100" width="70" height="60" rx="6" fill="#1e293b" stroke="#334155"/>
      <text x="230" y="120" text-anchor="middle" fill="#94a3b8" font-size="9">NDC</text>
      <text x="230" y="140" text-anchor="middle" fill="#f59e0b" font-size="11" font-weight="700">(0.0, 0.4)</text>
      <text x="230" y="153" text-anchor="middle" fill="#475569" font-size="8">x/1000*2-1</text>
      <!-- 3D Scene -->
      <rect x="300" y="180" width="180" height="100" rx="10" fill="#0f172a" stroke="#334155"/>
      <text x="390" y="200" text-anchor="middle" fill="#64748b" font-size="9">3D Scene (World Space)</text>
      <!-- Table surface -->
      <line x1="310" y1="250" x2="470" y2="250" stroke="#475569" stroke-width="1"/>
      <text x="410" y="262" text-anchor="middle" fill="#475569" font-size="8">Table surface z=0</text>
      <!-- Cube -->
      <rect x="315" y="235" width="15" height="15" rx="1" fill="#ef4444" stroke="#fca5a5" stroke-width="1"/>
      <!-- Hit point -->
      <circle cx="322" cy="240" r="4" fill="#22c55e" stroke="#86efac" stroke-width="1.5"/>
      <text x="345" y="228" fill="#22c55e" font-size="10" font-weight="600">Hit Point</text>
      <text x="345" y="240" fill="#22c55e" font-size="9">Vector3(0.4, -0.1, 0.04)</text>
      <!-- Arrow defs -->
      <defs>
        <marker id="arrowGray" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
          <path d="M0,0 L6,3 L0,6" fill="none" stroke="#475569" stroke-width="1"/>
        </marker>
      </defs>
    </svg>
  </div>
  <div class="proj-info">
    <h4>Projection Steps</h4>
    <ul class="step-list">
      <li><span class="sn">1</span> Gemini returns coordinates normalized to 0-1000</li>
      <li><span class="sn">2</span> Convert to NDC: x' = x/1000*2-1, y' = -(y/1000*2-1)</li>
      <li><span class="sn">3</span> Create virtual camera at snapshot position (top-down)</li>
      <li><span class="sn">4</span> Set Raycaster from camera through NDC point</li>
      <li><span class="sn">5</span> Intersect ray with all scene meshes (simGroup)</li>
      <li><span class="sn">6</span> First hit point = 3D world coordinate</li>
      <li><span class="sn">7</span> Walk up parent chain to find bodyID</li>
    </ul>
    <div style="margin-top:12px;background:#1e293b;border-radius:8px;padding:10px;font-size:10px;color:#94a3b8;font-family:'SF Mono',monospace;line-height:1.6;">
      ndc = (x/<span style="color:#f59e0b">1000</span>*<span style="color:#f59e0b">2</span>-<span style="color:#f59e0b">1</span>, -(y/<span style="color:#f59e0b">1000</span>*<span style="color:#f59e0b">2</span>-<span style="color:#f59e0b">1</span>))<br>
      raycaster.<span style="color:#22d3ee">setFromCamera</span>(ndc, cam)<br>
      hits = raycaster.<span style="color:#22d3ee">intersectObjects</span>(...)<br>
      <span style="color:#34d399">return</span> hits[<span style="color:#f59e0b">0</span>].point  <span style="color:#475569">// THREE.Vector3</span>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- 7. DETECTION MODES -->
<!-- ============================================================ -->
<div class="section-title">7. Detection Modes</div>
<div class="modes-grid">
  <div class="mode-card boxes">
    <div class="icon">&#x1F4E6;</div>
    <div class="name">Bounding Boxes</div>
    <div class="en">Rectangular regions</div>
    <div class="desc">Returns a bounding rectangle per object. Fast localization for pick-and-place tasks. Supported by both models.</div>
    <div class="output">{"box_2d": [y1, x1, y2, x2],<br> "label": "red cube"}</div>
  </div>
  <div class="mode-card masks">
    <div class="icon">&#x1F3AD;</div>
    <div class="name">Segmentation Masks</div>
    <div class="en">Pixel-level outlines</div>
    <div class="desc">Returns pixel-level contour masks for precise boundaries. ER 1.5 model only (not supported by Gemini 3 Flash).</div>
    <div class="output">{"box_2d": [...],<br> "mask": "base64...",<br> "label": "red cube"}</div>
  </div>
  <div class="mode-card points">
    <div class="icon">&#x1F4CD;</div>
    <div class="name">Points</div>
    <div class="en">Exact center coordinates</div>
    <div class="desc">Returns precise center coordinates. Ideal for dense scenes with many objects. Coordinates in [y, x] format.</div>
    <div class="output">{"point": [y, x],<br> "label": "red cube"}</div>
  </div>
</div>

<!-- ============================================================ -->
<!-- 8. FILE DEPENDENCY MAP -->
<!-- ============================================================ -->
<div class="section-title">8. File Dependency Map</div>
<div class="dep-grid">
  <div class="dep-card ui">
    <div class="fname">App.tsx</div>
    <div class="lines">~550 lines | Main Controller</div>
    <div class="role">Orchestrates AI loop: snapshot &rarr; inference &rarr; projection &rarr; pickup</div>
    <div class="deps">
      <span class="dep-tag i">MujocoSim</span>
      <span class="dep-tag i">GoogleGenAI</span>
      <span class="dep-tag i">3 UI components</span>
    </div>
  </div>
  <div class="dep-card phy">
    <div class="fname">MujocoSim.ts</div>
    <div class="lines">~350 lines | Sim Core</div>
    <div class="role">Physics loop, model loading, frame stepping</div>
    <div class="deps">
      <span class="dep-tag i">RenderSystem</span>
      <span class="dep-tag i">IkSystem</span>
      <span class="dep-tag i">SequenceAnimator</span>
      <span class="dep-tag i">RobotLoader</span>
    </div>
  </div>
  <div class="dep-card ren">
    <div class="fname">RenderSystem.ts</div>
    <div class="lines">~325 lines | 3D Engine</div>
    <div class="role">Three.js scene, camera, lighting, raycasting</div>
    <div class="deps">
      <span class="dep-tag i">GeomBuilder</span>
      <span class="dep-tag e">project2DTo3D</span>
      <span class="dep-tag e">getCanvasSnapshot</span>
    </div>
  </div>
  <div class="dep-card ctrl">
    <div class="fname">SequenceAnimator.ts</div>
    <div class="lines">~337 lines | State Machine</div>
    <div class="role">15-step pick sequence, joint interpolation, gripper control</div>
    <div class="deps">
      <span class="dep-tag i">IkSystem</span>
    </div>
  </div>
  <div class="dep-card ctrl">
    <div class="fname">FrankaAnalyticalIK.ts</div>
    <div class="lines">~246 lines | IK Solver</div>
    <div class="role">Analytical 7-DOF joint computation (He &amp; Liu)</div>
    <div class="deps">
      <span class="dep-tag i">THREE.Matrix4</span>
    </div>
  </div>
  <div class="dep-card ctrl">
    <div class="fname">IkSystem.ts</div>
    <div class="lines">~180 lines | IK Manager</div>
    <div class="role">Redundancy resolution, q7 scan, cost minimization</div>
    <div class="deps">
      <span class="dep-tag i">FrankaAnalyticalIK</span>
      <span class="dep-tag i">TransformControls</span>
    </div>
  </div>
  <div class="dep-card phy">
    <div class="fname">RobotLoader.ts</div>
    <div class="lines">~195 lines | Model Loader</div>
    <div class="role">Downloads MJCF + meshes from DeepMind, injects cubes &amp; tray</div>
    <div class="deps">
      <span class="dep-tag i">MuJoCo FS</span>
      <span class="dep-tag i">DOMParser</span>
    </div>
  </div>
  <div class="dep-card ren">
    <div class="fname">GeomBuilder.ts</div>
    <div class="lines">~150 lines | Geometry Factory</div>
    <div class="role">MuJoCo shapes &rarr; Three.js BufferGeometry</div>
    <div class="deps">
      <span class="dep-tag i">CapsuleGeometry</span>
    </div>
  </div>
</div>

<!-- Footer -->
<div class="tech-footer">
  <span class="tech-pill">React <span class="ver">19</span></span>
  <span class="tech-pill">TypeScript <span class="ver">5.8</span></span>
  <span class="tech-pill">Three.js <span class="ver">r181</span></span>
  <span class="tech-pill">MuJoCo <span class="ver">WASM</span></span>
  <span class="tech-pill">Gemini <span class="ver">ER 1.5</span></span>
  <span class="tech-pill">Vite <span class="ver">6</span></span>
  <span class="tech-pill">Franka Panda <span class="ver">7-DOF</span></span>
</div>

</div>
</body>
</html>
